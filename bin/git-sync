#!/bin/bash

set -e

current_branch="$(git branch | egrep "^\*" | cut -c3-)"

git checkout -q master
git pull -q

git checkout -q local_qa

set +e

echo "gethering branches to be rebased or not to be rebased into master"
if [ $# -gt 0 ]; then
	if [ "$1" = all ]; then
		branch_merged="$(git branch | cut -c3- | egrep '^[A-Z]+-[0-9]+$')"
	else
		branch_merged="$@"
	fi
	branch_no_merged=""
else
	branch_merged="$(git branch --merged | cut -c3- | egrep '^[A-Z]+-[0-9]+$')"
	branch_no_merged="$(git branch --no-merged | cut -c3- | egrep '^[A-Z]+-[0-9]+$')"
fi

set -e

echo "branches to be rebased into master:"
echo "$branch_merged"
echo "branches not to be rebased into master:"
echo "$branch_no_merged"

read -p "Press any key to continue, or press Ctrl-C to abort. "

echo "Resetting local_qa into master"
git reset -q --hard master

for b in $branch_merged; do
	echo "Rebasing $b into master"
	git checkout -q "$b"
	git rebase -q master
	echo "Merging $b into local_qa"
	git checkout -q local_qa
	git merge -q "$b"
done

for b in $branch_no_merged; do
	echo "Rebasing $b into master"
	git checkout -q "$b"
	git rebase -q master
done

echo "Checking out to $current_branch"
git checkout "$current_branch"
git branch
