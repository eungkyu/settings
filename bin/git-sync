#!/bin/bash

set -e

git checkout -q master
git pull -q

git checkout -q local_qa

set +e

echo "gethering branches to be rebased or not to be rebased into master"
if [ $# -gt 0 ]; then
	if [ "$1" = all ]; then
		br_merged="$(git br | cut -c3- | egrep '^[A-Z]+-[0-9]+$')"
	else
		br_merged="$@"
	fi
	br_no_merged=""
else
	br_merged="$(git br --merged | cut -c3- | egrep '^[A-Z]+-[0-9]+$')"
	br_no_merged="$(git br --no-merged | cut -c3- | egrep '^[A-Z]+-[0-9]+$')"
fi

set -e

echo "branches to be rebased into master:"
echo "$br_merged"
echo "branches not to be rebased into master:"
echo "$br_no_merged"

read -p "Press any key to continue, or press Ctrl-C to abort. "

echo "Resetting local_qa into master"
git reset -q --hard master

for b in $br_merged; do
	echo "Rebasing $b into master"
	git checkout -q "$b"
	git rebase -q master
	echo "Merging $b into local_qa"
	git checkout -q local_qa
	git merge -q "$b"
done

for b in $br_no_merged; do
	echo "Rebasing $b into master"
	git checkout -q "$b"
	git rebase -q master
done

git checkout -q local_qa
echo "List of merged branches"
git br --merged
echo "List of no merged branches"
git br --no-merged

git checkout -q master
